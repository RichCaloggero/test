<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>test</title>
<script src="./bufferToWave.js"></script>
</head>
<body>
<h1>Test</h1>
<button>get audio</button>
<audio controls></audio>

<div id="log" role="log"></div>

<script>
const a = new AudioContext();
const audioElement = document.querySelector("audio");

document.querySelector("button").addEventListener("click", e => {
processAudio("./t.mp3");
});
log ("ready.");


function processAudio (url) {
fetch(url)
.then(response=> {
if (response.ok) return response.arrayBuffer();
else throw new Error(response.statusText);
 }).then(data => a.decodeAudioData(data))
.then(buffer => {
log ("File read ok.");
const c = new OfflineAudioContext(2, buffer.length, 44100);
const s = c.createBufferSource();
s.buffer = buffer;
s.connect(c.destination);
s.start();

c.startRendering().then(buffer => {
log(`rendering complete; ${buffer.duration} seconds of audio`);
const blob = bufferToWave(buffer, buffer.length);
log("- converted to .wav...");
url = URL.createObjectURL(blob);
audioElement.src = url;
log("- url created...");
});

}).catch(error => alert (error));
} // get2


function get1 (url) {
fetch(url)
.then(response=> {
if (response.ok) return response.arrayBuffer();
else throw new Error(response.statusText);
 }).then(data => c.decodeAudioData(data))
.then(buffer => {
  const blob = new Blob(buffer, { 'type' : 'audio/ogg; codecs=opus' });
const url = URL.createObjectURL(blob);
a.src = url;
a.play();

})
.catch(error => alert (error));
} // get1

function log(text) {
const p = document.createElement("p");
p.appendChild(document.createTextNode(text));
document.querySelector("#log").appendChild(p);
} // log

</script>

</body>
</html>
